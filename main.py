import json
import websocket
import telebot
import time

# üîπ API-–∫–ª—é—á–∏
telegram_token = "7849765435:AAGKSvUGXFmjTkxGFIphqiGIubinOedJvJg"
chat_id = "1466935078"
bot = telebot.TeleBot(telegram_token)

# üîπ WebSocket URL –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ Bybit
BYBIT_WS_URL = "wss://stream.bybit.com/v5/public/linear"

# üîπ –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
def on_message(ws, message):
    try:
        data = json.loads(message)
    except json.JSONDecodeError:
        print(f"–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: {message}")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
    if "topic" in data and "subscribe" in data.get("op", ""):
        print("–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–∞!")  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
        return  # –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –ª–∏–∫–≤–∏–¥–∞—Ü–∏–π
    if "topic" in data and "liquidation" in data["topic"]:
        print(f"–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: {data}")  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏
        liquidation_data = data.get("data", {})

        if isinstance(liquidation_data, dict):  # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å
            symbol = liquidation_data.get("symbol", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
            side = "üü• Short" if liquidation_data.get("side") == "Sell" else "üü© Long"
            size = float(liquidation_data.get("size", 0))
            price = float(liquidation_data.get("price", 0))
            value = size * price  # –û–±—â–∞—è —Å—É–º–º–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ –≤ USDT

            if value > 100000:  # –§–∏–ª—å—Ç—Ä –ø–æ –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è–º > $100K
                msg = f"‚ö° –ö—Ä—É–ø–Ω–∞—è –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è {symbol}!\nüí∞ {side} –ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ {value:.2f} USDT\nüìâ –¶–µ–Ω–∞: {price:.2f}"
                bot.send_message(chat_id, msg)
                print(msg)  # –õ–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å
        else:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: {liquidation_data}")
    else:
        print(f"–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ–∂–∏–¥–∞–µ–º–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ: {data}")

def on_error(ws, error):
    print(f"–û—à–∏–±–∫–∞ WebSocket: {error}")

def on_close(ws, close_status_code, close_msg):
    print("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ")

def on_open(ws):
    print("üîó WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω! –û–∂–∏–¥–∞–µ–º –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏...")
    subscribe_msg = {
        "op": "subscribe",
        "args": ["liquidation.BTCUSDT", "liquidation.ETHUSDT", "liquidation.SOLUSDT"]
    }
    ws.send(json.dumps(subscribe_msg))

def run_ws():
    """ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket """
    while True:
        ws = websocket.WebSocketApp(
            BYBIT_WS_URL,  
            on_message=on_message,
            on_error=on_error,
            on_close=on_close
        )
        ws.on_open = on_open
        ws.run_forever()
        print("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...")
        time.sleep(5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º

# –ó–∞–ø—É—Å–∫ WebSocket —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
run_ws()
